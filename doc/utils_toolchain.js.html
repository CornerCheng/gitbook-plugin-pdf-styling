<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: utils/toolchain.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: utils/toolchain.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * **Utilities leveraged in several places while processing the book.**

 * All of them are bound to the `book` instance at runtime.

 * @module utils/toolchain
 */

var fs = require('fs');
var _ = require('lodash');
var Q = require('q');
var path = require('path');

var execAsync = require('./exec').async;

// Post-processing units.
var pp = {};
pp.workflow = require('../lib/post-processing/workflow');
pp.background = require('../lib/post-processing/background');

/**
 * Check first if there's any post-processing actually pending.
 *
 * Exit early if none reported. Otherwise, start with moving the book to a
 * temporary location before further processing (solves path issues with
 * `pdftk`, among other tools, where the input path must differ from the output
 * path).
 */
function preRun(backgroundCfg, foregroundCfg) {
  var book = this;

  // Very simple strategy for now, could be tweaked in the future though: some
  // configuration validation has already been enforced using JSON-Schema but it
  // is not perfect.
  return Q()
  .then(function() {
    if (backgroundCfg || foregroundCfg) {
      book.options.pdfStyling = {};
      return pp.workflow.createTmp.call(book);
    } else {
      throw new Error("Nothing to do, aborting.");
    }
  });
}

function postRun() {
  var book = this;

  return Q()
  .then(_.bind(pp.workflow.cleanupTmp, book))
  .then(function() {
    book.log.info.ln('completed pdf post-processing');
  });
}

// Log error, then abort.
function handleError(err) {
  this.log.error.ln('error with pdf-styling: ', err.stack || err.message || err);
  this.log.warn.ln('aborting post-processing of pdf');

  return Q();
}

/**
 * Perform initial checks.
 */
function init() {
  var book = this;

  return Q()
  .then(function() {
    if (book.options.generator != 'pdf')
      throw new Error('invalid book format, aborting');
  })
  .then(function() {
    book.log.info.ln('start pdf post-processing');
  });
}

/**
 * Extract relevant conf about background and foreground from book's
 * configuration.
 */
function readConfiguration() {
  var cfg = this.config.get('pluginsConfig.pdf-styling', {});
  return Q([cfg.background, cfg.foreground]);
}

/**
 * Trigger background and foreground post-processing units.
 */
function runPostProcesses(backgroundCfg, foregroundCfg) {
  var book = this;

  return Q()
  .then(_.bind(preRun, book, backgroundCfg, foregroundCfg))
  .then(_.bind(pp.background.run, book, backgroundCfg))
  // TODO: pp.foreground
  .then(_.bind(postRun, book))
  .fail(_.bind(handleError, book));
}

module.exports = {
  init: init,
  readConfiguration: readConfiguration,
  runPostProcesses: runPostProcesses
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-post-processing_background.html">post-processing/background</a></li><li><a href="module-post-processing_workflow.html">post-processing/workflow</a></li><li><a href="module-utils_exec.html">utils/exec</a></li><li><a href="module-utils_function.html">utils/function</a></li><li><a href="module-utils_string.html">utils/string</a></li><li><a href="module-utils_toolchain.html">utils/toolchain</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Fri Dec 18 2015 01:58:22 GMT+0100 (CET)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
